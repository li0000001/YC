<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烟草数据在线分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .upload-zone { border: 2px dashed #dee2e6; border-radius: 10px; padding: 30px; text-align: center; transition: all 0.3s ease; background-color: #ffffff; }
        .upload-zone:hover { border-color: #0d6efd; background-color: #f8f9ff; }
        .positive-diff { color: #198754; font-weight: bold; }
        .negative-diff { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-bar me-2"></i>
                烟草数据在线分析系统
            </a>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- 文件上传区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>数据文件上传
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="upload-zone">
                                    <i class="fas fa-file-csv fa-3x text-primary mb-3"></i>
                                    <h6>价位段数据 (jwdcx.csv)</h6>
                                    <input type="file" class="form-control" accept=".csv" id="jwdcx-file" onchange="handleFileUpload(this, 'jwdcx')">
                                    <div class="upload-status mt-2" id="jwdcx-status"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="upload-zone">
                                    <i class="fas fa-tags fa-3x text-success mb-3"></i>
                                    <h6>价格数据 (price.csv)</h6>
                                    <input type="file" class="form-control" accept=".csv" id="price-file" onchange="handleFileUpload(this, 'price')">
                                    <div class="upload-status mt-2" id="price-status"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="upload-zone">
                                    <i class="fas fa-table fa-3x text-info mb-3"></i>
                                    <h6>原始订单数据 (input.csv)</h6>
                                    <input type="file" class="form-control" accept=".csv" id="input-file" onchange="handleFileUpload(this, 'input')">
                                    <div class="upload-status mt-2" id="input-status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查询区域 -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-search me-2"></i>价位段查询
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">选择价位段</label>
                            <select class="form-select" id="segment-select">
                                <option value="">请先上传价位段数据</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">输入档位（多个用逗号分隔）</label>
                            <input type="text" class="form-control" id="segment-levels" placeholder="例如: 27,28,29">
                        </div>
                        <button class="btn btn-primary" onclick="querySegment()">
                            <i class="fas fa-search me-1"></i>查询
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-balance-scale me-2"></i>档位查询
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">输入档位</label>
                            <input type="number" class="form-control" id="grade-input" placeholder="例如: 27">
                        </div>
                        <button class="btn btn-success" onclick="queryGrade()">
                            <i class="fas fa-search me-1"></i>查询
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 对比区域 -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-balance-scale me-2"></i>价位段对比
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">价位段1</label>
                                <select class="form-select" id="segment1-select">
                                    <option value="">请先上传数据</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">价位段2</label>
                                <select class="form-select" id="segment2-select">
                                    <option value="">请先上传数据</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">输入档位</label>
                            <input type="text" class="form-control" id="compare-levels" placeholder="例如: 27,28,29">
                        </div>
                        <button class="btn btn-warning" onclick="compareSegments()">
                            <i class="fas fa-balance-scale me-1"></i>对比
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>档位对比
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">档位1</label>
                                <input type="number" class="form-control" id="grade1-input" placeholder="例如: 27">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">档位2</label>
                                <input type="number" class="form-control" id="grade2-input" placeholder="例如: 28">
                            </div>
                        </div>
                        <button class="btn btn-info mt-3" onclick="compareGrades()">
                            <i class="fas fa-exchange-alt me-1"></i>对比
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table me-2"></i>查询结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="results-table">
                                <thead id="results-header">
                                    <tr><th>请先上传数据文件并执行查询</th></tr>
                                </thead>
                                <tbody id="results-body">
                                </tbody>
                            </table>
                        </div>
                        <div id="results-summary" class="mt-3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GBK/GB2312解码器
        function decodeGBK(arrayBuffer) {
            const bytes = new Uint8Array(arrayBuffer);
            let result = '';
            let i = 0;
            
            while (i < bytes.length) {
                const byte1 = bytes[i];
                
                if (byte1 < 0x80) {
                    // ASCII字符
                    result += String.fromCharCode(byte1);
                    i++;
                } else if (byte1 >= 0x81 && byte1 <= 0xFE && i + 1 < bytes.length) {
                    // GBK双字节字符
                    const byte2 = bytes[i + 1];
                    if (byte2 >= 0x40 && byte2 <= 0xFE && byte2 !== 0x7F) {
                        // 使用GBK映射表（简化版）
                        const code = (byte1 << 8) | byte2;
                        try {
                            result += String.fromCharCode(code);
                        } catch (e) {
                            result += '?';
                        }
                        i += 2;
                    } else {
                        result += '?';
                        i++;
                    }
                } else {
                    result += '?';
                    i++;
                }
            }
            return result;
        }

        // 数据存储
        let jwdcxData = [];
        let priceData = [];
        let inputData = [];

        // CSV解析工具
        function parseCSV(text) {
            // 清理BOM标记和特殊字符
            text = text.replace(/^\uFEFF/, '');
            const lines = text.trim().split(/\r?\n/);
            
            // 处理可能的分隔符问题
            const delimiter = text.includes('\t') ? '\t' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // 处理引号内的逗号
                let values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').replace(/^"|"$/g, '');
                });
                data.push(row);
            }
            return data;
        }

        function parseJwdcxData(text) {
            const lines = text.split('\n');
            const allData = [];
            let segmentName = null;
            let segmentLines = [];

            for (const line of lines) {
                const strippedLine = line.trim();
                if (!strippedLine) continue;
                
                if (strippedLine.startsWith('"价位段：')) {
                    if (segmentName && segmentLines.length > 0) {
                        allData.push(...parseSegmentToTidyData(segmentName, segmentLines));
                    }
                    segmentName = strippedLine.split(',')[0].replace(/"/g, '').replace('按价位段投放情况如下(单位:条)', '').trim();
                    segmentLines = [];
                } else if (segmentName) {
                    segmentLines.push(line);
                }
            }
            
            if (segmentName && segmentLines.length > 0) {
                allData.push(...parseSegmentToTidyData(segmentName, segmentLines));
            }

            return allData.map(item => ({
                ...item,
                可定量: parseFloat(item.可定量) || 0,
                上限: parseFloat(item.上限) || 0
            })).filter(item => item.可定量 > 0);
        }

        function parseSegmentToTidyData(segmentName, lines) {
            let headerFound = false;
            let startIndex = 0;
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim().startsWith('序号,卷烟编码,卷烟名称')) {
                    headerFound = true;
                    startIndex = i;
                    break;
                }
            }
            
            if (!headerFound) return [];
            
            const relevantLines = lines.slice(startIndex);
            const csvText = relevantLines.join('\n');
            const rows = parseCSV(csvText);
            
            const limitRow = rows.find(row => row['卷烟编码'] === '价位段上限');
            const products = rows.filter(row => row['卷烟编码'] !== '价位段上限');
            
            if (!limitRow) return [];
            
            const tidyRows = [];
            const dataColumns = Object.keys(products[0] || {}).filter(key => 
                !['序号', '卷烟编码', '卷烟名称'].includes(key)
            );
            
            for (const product of products) {
                const productName = product['卷烟名称'];
                for (const level of dataColumns) {
                    const quantity = parseFloat(product[level]) || 0;
                    const limit = parseFloat(limitRow[level]) || 0;
                    
                    tidyRows.push({
                        价位段: segmentName,
                        档位: level,
                        商品: productName,
                        上限: limit,
                        可定量: quantity
                    });
                }
            }
            
            return tidyRows;
        }

        function parsePriceData(text) {
            const data = parseCSV(text);
            return data.map(item => ({
                规格名称: item['规格名称'] || item['规格'],
                批发价: parseFloat(item['批发价']) || 0
            }));
        }

        function parseInputData(text, priceData) {
            const data = parseCSV(text);
            
            // 调试：显示实际列名
            if (data.length > 0) {
                console.log('实际列名:', Object.keys(data[0]));
                console.log('数据样本:', data.slice(0, 3));
            }
            
            // 智能列名检测
            const columnMap = {};
            if (data.length > 0) {
                const keys = Object.keys(data[0]);
                for (const key of keys) {
                    const cleanKey = key.trim();
                    if (cleanKey.includes('规格') || cleanKey.includes('名称')) {
                        columnMap.规格名称 = key;
                    } else if (cleanKey.includes('策略') || cleanKey.includes('标准')) {
                        columnMap.策略标准 = key;
                    }
                }
            }
            
            console.log('列名映射:', columnMap);
            
            const priceMap = new Map(priceData.map(item => [item.规格名称, item.批发价]));
            
            const records = [];
            
            // 获取实际列名
            const ruleKey = columnMap.策略标准 || Object.keys(data[0] || {}).find(k => k.includes('策略')) || '策略标准';
            const specKey = columnMap.规格名称 || Object.keys(data[0] || {}).find(k => k.includes('规格')) || '规格名称';
            
            console.log('使用列名:', { ruleKey, specKey });
            
            // 改进的正则表达式，支持中文格式
            const patterns = [
                /(\d+)(?:档)?(?:[-~～](\d+)(?:档)?)?\s*[:：]?\s*([\d.]+)\s*条/g,
                /(?:档位|档)(\d+)(?:[-~～](\d+))?[:：]\s*([\d.]+)\s*条/g,
                /(\d+)[-~～](\d+)[档]?:\s*([\d.]+)\s*条/g,
                /(\d+)[档]?:\s*([\d.]+)\s*条/g  // 单档位格式
            ];
            
            let totalRules = 0;
            for (const row of data) {
                const rule = (row[ruleKey] || '').toString();
                const spec = (row[specKey] || '').toString();
                
                if (!rule || !spec) continue;
                
                console.log('处理规则:', rule, '规格:', spec);
                totalRules++;
                
                let found = false;
                for (const pattern of patterns) {
                    let match;
                    while ((match = pattern.exec(rule)) !== null) {
                        let start, end, qty;
                        
                        if (match.length === 4) {
                            // 标准格式: 档位范围
                            start = parseInt(match[1]);
                            end = match[2] ? parseInt(match[2]) : start;
                            qty = parseFloat(match[3]);
                        } else if (match.length === 3) {
                            // 单档位格式
                            start = parseInt(match[1]);
                            end = start;
                            qty = parseFloat(match[2]);
                        }
                        
                        if (isNaN(start) || isNaN(qty) || qty <= 0) continue;
                        
                        console.log(`找到规则: ${start}-${end}档: ${qty}条`);
                        
                        for (let grade = start; grade <= end; grade++) {
                            records.push({
                                档位: grade,
                                规格名称: spec,
                                条数: qty,
                                批发价: priceMap.get(spec) || 0,
                                金额: qty * (priceMap.get(spec) || 0)
                            });
                        }
                        found = true;
                    }
                    if (found) break;
                    pattern.lastIndex = 0; // 重置正则表达式
                }
            }
            
            console.log(`总共处理 ${totalRules} 条规则，生成 ${records.length} 条记录`);
            
            return records;
        }

        // 文件上传处理
        async function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            const statusDiv = document.getElementById(`${type}-status`);
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';

            try {
                console.log(`开始处理 ${type} 文件:`, file.name, '大小:', file.size, '字节');
                
                // 尝试多种编码方式读取文件
                const arrayBuffer = await file.arrayBuffer();
                let text = new TextDecoder('utf-8', { fatal: false }).decode(arrayBuffer);
                
                console.log('原始文本前200字符:', text.substring(0, 200));
                console.log('编码检测结果:');
                console.log('UTF-8解码长度:', text.length);
                console.log('包含乱码:', /[���]/.test(text));
                
                // 如果UTF-8解码失败（出现乱码），尝试GBK解码
                if (/[���]/.test(text) || !text.includes('规格') && !text.includes('策略')) {
                    console.log('检测到编码问题，尝试GBK解码');
                    text = decodeGBK(arrayBuffer);
                    console.log('GBK解码结果:', text.substring(0, 200));
                }
                
                console.log('最终文本前500字符:', text.substring(0, 500));
                let data;

                if (type === 'jwdcx') {
                    data = parseJwdcxData(text);
                    jwdcxData = data;
                    const segments = [...new Set(data.map(item => item.价位段))];
                    updateSegmentSelects(segments);
                    statusDiv.innerHTML = `<i class="fas fa-check-circle text-success"></i> 成功加载 ${data.length} 条记录`;
                } else if (type === 'price') {
                    data = parsePriceData(text);
                    priceData = data;
                    statusDiv.innerHTML = `<i class="fas fa-check-circle text-success"></i> 成功加载 ${data.length} 条价格记录`;
                } else if (type === 'input') {
                    if (priceData.length === 0) {
                        statusDiv.innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i> 请先上传价格数据';
                        return;
                    }
                    data = parseInputData(text, priceData);
                    inputData = data;
                    statusDiv.innerHTML = `<i class="fas fa-check-circle text-success"></i> 成功处理 ${data.length} 条记录`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<i class="fas fa-exclamation-circle text-danger"></i> 处理失败: ${error.message}`;
            }
        }

        function updateSegmentSelects(segments) {
            const selects = ['segment-select', 'segment1-select', 'segment2-select'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                select.appendChild(new Option('所有价位段', '所有价位段'));
                segments.forEach(segment => {
                    select.appendChild(new Option(segment, segment));
                });
            });
        }

        // 查询功能
        function querySegment() {
            if (jwdcxData.length === 0) {
                alert('请先上传价位段数据！');
                return;
            }

            const segment = document.getElementById('segment-select').value;
            const levelsText = document.getElementById('segment-levels').value;
            const levels = levelsText ? levelsText.split(',').map(l => l.trim()) : [];

            let filtered = jwdcxData;
            if (segment !== '所有价位段') {
                filtered = filtered.filter(item => item.价位段 === segment);
            }
            if (levels.length > 0) {
                filtered = filtered.filter(item => levels.includes(item.档位.toString()));
            }

            // 按商品聚合
            const aggregated = {};
            for (const item of filtered) {
                const key = item.商品;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        商品: key,
                        可定量: 0,
                        上限: item.上限,
                        价位段: item.价位段
                    };
                }
                aggregated[key].可定量 += item.可定量;
            }

            const result = Object.values(aggregated).sort((a, b) => b.可定量 - a.可定量);
            displayResults(result, [
                { key: '商品', label: '商品' },
                { key: '可定量', label: '可定量' },
                { key: '上限', label: '上限' },
                { key: '价位段', label: '价位段' }
            ]);
        }

        function queryGrade() {
            if (inputData.length === 0) {
                alert('请先上传原始订单数据和价格数据！');
                return;
            }

            const grade = document.getElementById('grade-input').value;
            if (!grade) {
                alert('请输入档位！');
                return;
            }

            const result = inputData.filter(item => item.档位 === parseInt(grade));
            displayResults(result, [
                { key: '规格名称', label: '规格' },
                { key: '条数', label: '条数' },
                { key: '批发价', label: '批发价' },
                { key: '金额', label: '金额' }
            ]);
        }

        function compareSegments() {
            if (jwdcxData.length === 0) {
                alert('请先上传价位段数据！');
                return;
            }

            const segment1 = document.getElementById('segment1-select').value;
            const segment2 = document.getElementById('segment2-select').value;
            const levelsText = document.getElementById('compare-levels').value;
            const levels = levelsText ? levelsText.split(',').map(l => l.trim()) : [];

            let filtered1 = jwdcxData;
            let filtered2 = jwdcxData;

            if (segment1 !== '所有价位段') {
                filtered1 = filtered1.filter(item => item.价位段 === segment1);
            }
            if (segment2 !== '所有价位段') {
                filtered2 = filtered2.filter(item => item.价位段 === segment2);
            }
            if (levels.length > 0) {
                filtered1 = filtered1.filter(item => levels.includes(item.档位.toString()));
                filtered2 = filtered2.filter(item => levels.includes(item.档位.toString()));
            }

            // 按商品和档位聚合
            const agg1 = {};
            const agg2 = {};

            for (const item of filtered1) {
                const key = `${item.商品}_${item.档位}`;
                if (!agg1[key]) {
                    agg1[key] = { 商品: item.商品, 档位: item.档位, 可定量: 0, 上限: item.上限 };
                }
                agg1[key].可定量 += item.可定量;
            }

            for (const item of filtered2) {
                const key = `${item.商品}_${item.档位}`;
                if (!agg2[key]) {
                    agg2[key] = { 商品: item.商品, 档位: item.档位, 可定量: 0, 上限: item.上限 };
                }
                agg2[key].可定量 += item.可定量;
            }

            const allKeys = new Set([...Object.keys(agg1), ...Object.keys(agg2)]);
            const result = [];

            for (const key of allKeys) {
                const item1 = agg1[key] || { 可定量: 0, 上限: 0 };
                const item2 = agg2[key] || { 可定量: 0, 上限: 0 };

                result.push({
                    商品: item1.商品 || item2.商品,
                    档位: item1.档位 || item2.档位,
                    可定量_1: item1.可定量,
                    可定量_2: item2.可定量,
                    可定量差异: item1.可定量 - item2.可定量,
                    上限_1: item1.上限,
                    上限_2: item2.上限,
                    上限差异: item1.上限 - item2.上限
                });
            }

            result.sort((a, b) => Math.abs(b.可定量差异) - Math.abs(a.可定量差异));
            displayResults(result, [
                { key: '商品', label: '商品' },
                { key: '档位', label: '档位' },
                { key: '可定量_1', label: '价位段1可定量' },
                { key: '可定量_2', label: '价位段2可定量' },
                { key: '可定量差异', label: '可定量差异' },
                { key: '上限_1', label: '价位段1上限' },
                { key: '上限_2', label: '价位段2上限' },
                { key: '上限差异', label: '上限差异' }
            ]);
        }

        function compareGrades() {
            if (inputData.length === 0) {
                alert('请先上传原始订单数据和价格数据！');
                return;
            }

            const grade1 = document.getElementById('grade1-input').value;
            const grade2 = document.getElementById('grade2-input').value;
            if (!grade1 || !grade2) {
                alert('请输入两个档位！');
                return;
            }

            const filtered1 = inputData.filter(item => item.档位 === parseInt(grade1));
            const filtered2 = inputData.filter(item => item.档位 === parseInt(grade2));

            const agg1 = {};
            const agg2 = {};

            for (const item of filtered1) {
                if (!agg1[item.规格名称]) {
                    agg1[item.规格名称] = { 规格名称: item.规格名称, 条数: 0, 批发价: item.批发价, 金额: 0 };
                }
                agg1[item.规格名称].条数 += item.条数;
                agg1[item.规格名称].金额 += item.金额;
            }

            for (const item of filtered2) {
                if (!agg2[item.规格名称]) {
                    agg2[item.规格名称] = { 规格名称: item.规格名称, 条数: 0, 批发价: item.批发价, 金额: 0 };
                }
                agg2[item.规格名称].条数 += item.条数;
                agg2[item.规格名称].金额 += item.金额;
            }

            const allSpecs = new Set([...Object.keys(agg1), ...Object.keys(agg2)]);
            const result = [];

            for (const spec of allSpecs) {
                const item1 = agg1[spec] || { 条数: 0, 金额: 0 };
                const item2 = agg2[spec] || { 条数: 0, 金额: 0 };

                result.push({
                    规格名称: spec,
                    [`条数_${grade1}`]: item1.条数,
                    [`条数_${grade2}`]: item2.条数,
                    差异: item1.条数 - item2.条数,
                    [`金额_${grade1}`]: item1.金额,
                    [`金额_${grade2}`]: item2.金额,
                    金额差异: item1.金额 - item2.金额
                });
            }

            result.sort((a, b) => Math.abs(b.差异) - Math.abs(a.差异));
            displayResults(result, [
                { key: '规格名称', label: '规格' },
                [`条数_${grade1}`, `档位${grade1}条数`],
                [`条数_${grade2}`, `档位${grade2}条数`],
                ['差异', '差异'],
                [`金额_${grade1}`, `档位${grade1}金额`],
                [`金额_${grade2}`, `档位${grade2}金额`],
                ['金额差异', '金额差异']
            ]);
        }

        function displayResults(data, columns) {
            const header = document.getElementById('results-header');
            const body = document.getElementById('results-body');
            
            if (!data || data.length === 0) {
                header.innerHTML = '<tr><th colspan="100" class="text-center">没有找到数据</th></tr>';
                body.innerHTML = '';
                return;
            }
            
            header.innerHTML = columns.map(col => `<th>${col.label || col}</th>`).join('');
            body.innerHTML = data.map(item => {
                const row = columns.map(col => {
                    const key = typeof col === 'string' ? col : col.key;
                    let value = item[key];
                    if (typeof value === 'number') {
                        if (key.includes('差异') || key.includes('金额')) {
                            return `<td class="${value > 0 ? 'positive-diff' : value < 0 ? 'negative-diff' : ''}">${value.toFixed(2)}</td>`;
                        }
                        return `<td>${Math.round(value)}</td>`;
                    }
                    return `<td>${value || ''}</td>`;
                }).join('');
                return `<tr>${row}</tr>`;
            }).join('');
        }
    </script>
</body>
</html>
